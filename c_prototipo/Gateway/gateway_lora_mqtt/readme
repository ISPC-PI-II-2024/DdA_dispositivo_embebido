ğŸš€ Gateway MQTT/WebSockets ESP32
Un gateway IoT inteligente basado en ESP32 que establece conexiÃ³n MQTT sobre WebSockets para comunicaciÃ³n bidireccional con sistemas backend.

ğŸ“‹ Tabla de Contenidos
CaracterÃ­sticas

Arquitectura

InstalaciÃ³n

ConfiguraciÃ³n

Uso

Mensajes MQTT

Estados del Sistema

API

Troubleshooting

ContribuciÃ³n

âœ¨ CaracterÃ­sticas
Conectividad
âœ… MQTT sobre WebSockets (Puerto 8083)

âœ… Dual-mode WiFi (STA + AP)

âœ… ReconexiÃ³n automÃ¡tica inteligente

âœ… ConfiguraciÃ³n persistente en flash

âœ… Brokers compatibles: EMQX, HiveMQ, Mosquitto

Confiabilidad
ğŸ”„ MÃ¡quina de estados robusta

ğŸ’¾ Almacenamiento persistente de configuraciÃ³n

ğŸ“Š Monitoreo de salud del sistema

ğŸš¨ Manejo de errores avanzado

â° Timeouts configurables

Interfaz
ğŸ“Ÿ Feedback visual en LCD

ğŸ“± Modo AP para configuraciÃ³n web

ğŸ“Š Logs detallados con emojis

ğŸ” DiagnÃ³stico en tiempo real

ğŸ—ï¸ Arquitectura
Diagrama de Flujo
text
[ESP32 Gateway] 
    â†’ [WiFi Connection] 
    â†’ [WebSocket Client] 
    â†’ [MQTT over WS] 
    â†’ [Cloud Broker]
Componentes Principales
Componente	FunciÃ³n
MQTTManual	ImplementaciÃ³n MQTT sobre WebSockets
WebSocketsClient	Cliente WebSocket para ESP32
Preferences	Almacenamiento persistente
WiFi	GestiÃ³n de conexiones de red
LCD	Interfaz visual de usuario
ğŸ”§ InstalaciÃ³n
Prerrequisitos
PlatformIO (recomendado) o Arduino IDE

ESP32 Dev Board

LCD I2C (opcional)

ConexiÃ³n WiFi disponible

Dependencias
ini
[env:esp32dev]
platform = espressif32
board = esp32dev
framework = arduino
monitor_speed = 115200
lib_deps = 
    links2004/WebSockets @ ^2.3.6
    bblanchon/ArduinoJson @ ^6.21.3
InstalaciÃ³n Paso a Paso
Clonar el repositorio


git clone https://github.com/tu-usuario/esp32-mqtt-gateway.git
cd esp32-mqtt-gateway
Abrir en PlatformIO


Compilar y subir

pio run -t upload
Monitor serial

pio device monitor

âš™ï¸ ConfiguraciÃ³n
ConfiguraciÃ³n Inicial
Primer inicio: El gateway crea un AP "ESP32-Gateway"

Conectar: Conectarse al AP desde cualquier dispositivo

Configurar: Acceder al portal web de configuraciÃ³n

Guardar: Ingresar credenciales WiFi y servidor MQTT

ConfiguraciÃ³n por Defecto
// Broker MQTT
String mqttServer = "broker.emqx.io";
int mqttPort = 8083;

// WiFi AP
const char* AP_SSID = "ESP32-Gateway";
const char* AP_PASSWORD = "";

// Tiempos
const unsigned long RECONNECT_INTERVAL = 10000;    // 10s
const unsigned long STATUS_INTERVAL = 30000;       // 30s
const unsigned long HEARTBEAT_INTERVAL = 25000;    // 25s

ğŸš€ Uso
Flujo de OperaciÃ³n Normal
text
1. POWER ON â†’ Cargar configuraciÃ³n
2. Â¿WiFi configurado? â†’ SÃ­: Conectar WiFi
3. Conectar WebSocket â†’ broker:8083/mqtt
4. Autenticar MQTT â†’ Enviar CONNECT
5. Sistema operativo â†’ Publicar datos
Comandos por Serial
Comando	FunciÃ³n
reset	Reinicia el gateway
status	Muestra estado actual
config	Muestra configuraciÃ³n

ğŸ“¨ Mensajes MQTT
Topics de PublicaciÃ³n
Estado del Gateway
Topic: gateway/estado

{
  "id": "ESP32-Gateway",
  "ip": "192.168.1.100",
  "rssi": -65,
  "reconexiones": 2,
  "heapLibre": 195232,
  "estado": "OPERATIVO"
}
Datos de Sensores
Topic: sensores/{tipo_sensor}/datos

{
  "sensor": "DHT22",
  "temperatura": 23.5,
  "humedad": 65.2,
  "timestamp": 1234567890
}
Heartbeat
Topic: gateway/heartbeat (implÃ­cito)

{
  "clientId": "ESP32-Gateway",
  "timestamp": 1234567890
}
Topics de SuscripciÃ³n
Comandos de Control
Topic: gateway/control

"reset"  // Reinicia el gateway
Datos de Sensores
Topic: sensors/+/data

+ actÃºa como comodÃ­n para cualquier sensor

ğŸ“Š Estados del Sistema
Secuencia de Estados

ESTADO_AP â†’ ESTADO_CONECTANDO_WIFI â†’ ESTADO_CONECTANDO_WS 
â†’ ESTADO_CONECTANDO_MQTT â†’ ESTADO_OPERATIVO
DescripciÃ³n de Estados
Estado	DescripciÃ³n	LCD Display
ESTADO_AP	Modo configuraciÃ³n	MODO CONFIGURACIÃ“N
ESTADO_CONECTANDO_WIFI	Conectando a WiFi	CONECTANDO WIFI
ESTADO_CONECTANDO_WS	Conectando WebSocket	CONECTANDO WS
ESTADO_CONECTANDO_MQTT	Autenticando MQTT	CONECTANDO MQTT
ESTADO_OPERATIVO	Sistema listo	SISTEMA OPERATIVO
ESTADO_RECONECTANDO	Recuperando conexiÃ³n	RECONECTANDO...

ğŸ”Œ API
Funciones Principales
GestiÃ³n de Conexiones

void conectarWiFi();          // Conectar a WiFi
void conectarWebSocket();     // Conectar WebSocket
void manejarReconexion();     // ReconexiÃ³n automÃ¡tica
PublicaciÃ³n de Datos

void publicarEstado();        // Estado del gateway
void publicarDatosSensor();   // Datos de sensores
void publicarHeartbeat();     // Heartbeat MQTT
ConfiguraciÃ³n

void cargarConfigWiFi();      // Cargar configuraciÃ³n
void guardarConfigWiFi();     // Guardar configuraciÃ³n
void iniciarAP();             // Modo punto de acceso
ğŸ› Troubleshooting
Problemas Comunes
No conecta a WiFi
SÃ­ntoma: Permanece en ESTADO_CONECTANDO_WIFI
SoluciÃ³n:

Verificar SSID y password

Revisar seÃ±al WiFi

Reiniciar configuraciÃ³n

No conecta a MQTT
SÃ­ntoma: Permanece en ESTADO_CONECTANDO_MQTT
SoluciÃ³n:

Verificar broker y puerto

Revisar firewall

Probar con broker pÃºblico

Memory Leaks
SÃ­ntoma: Heap libre disminuye
SoluciÃ³n:

Monitorear heapLibre en estado

Optimizar buffers

Reiniciar periÃ³dicamente

Logs de DiagnÃ³stico
Los logs usan emojis para fÃ¡cil identificaciÃ³n:

Emoji	Significado
âœ…	OperaciÃ³n exitosa
âŒ	Error crÃ­tico
ğŸ”„	ReconexiÃ³n
ğŸ“¤	PublicaciÃ³n
ğŸ“¥	RecepciÃ³n
ğŸ’“	Heartbeat
ğŸ¤ ContribuciÃ³n
Â¡Las contribuciones son bienvenidas!

CÃ³mo Contribuir
Fork el proyecto

Crear una rama (git checkout -b feature/nueva-funcionalidad)

Commit los cambios (git commit -m 'Agregar nueva funcionalidad')

Push a la rama (git push origin feature/nueva-funcionalidad)

Abrir un Pull Request

EstÃ¡ndares de CÃ³digo
DocumentaciÃ³n en espaÃ±ol

Comentarios claros y concisos

Logs con emojis para mejor legibilidad

Manejo de errores robusto

ğŸ“„ Licencia
Este proyecto estÃ¡ bajo la Licencia MIT - ver el archivo LICENSE para mÃ¡s detalles.

ğŸ“ Soporte
Issues: GitHub Issues

Email: soporte@tudominio.com

DocumentaciÃ³n: Wiki del proyecto

ğŸ¯ PrÃ³ximas CaracterÃ­sticas
AutenticaciÃ³n MQTT con usuario/password

Soporte para LoRaWAN

OTA (Over-The-Air) updates

Dashboard web integrado

MÃºltiples brokers simultÃ¡neos

